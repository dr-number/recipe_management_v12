<script>
    let currentUserId = null;
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function runInServerFetch(url, formData) {
        const head = {
            method: "POST",
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        };
        return fetch(url, head);
    }
    
    // Функция для обработки регистрации
    async function handleRegistrationSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        const formData = new FormData(form);
        const jsonData = {};
        
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }
    
        submitBtn.textContent = 'Регистрация...';
        submitBtn.disabled = true;
    
        try {
            const response = await runInServerFetch('http://localhost:8700/main/allow_any/create_account/', jsonData);
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.user_id || result.id) {
                    currentUserId = result.user_id || result.id;
                    showConfirmationModal();
                } else {
                    alert('Аккаунт успешно создан!');
                    window.location.reload();
                }
            } else {
                const errorData = await response.json();
                alert('Ошибка: ' + (errorData.detail || JSON.stringify(errorData)));
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
    
    async function handleLoginSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        const formData = new FormData(form);
        const jsonData = {};
        
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }

        submitBtn.textContent = 'Вход...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('http://localhost:8700/main/allow_any/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(jsonData)
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.token) {
                    localStorage.setItem('auth_token', result.token);
                    await renderLkPage();
                } else {
                    alert('Ошибка входа: токен не получен');
                }
            } else {
                const errorData = await response.json();
                alert('Ошибка: ' + (errorData.errorText || JSON.stringify(errorData)));
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('loginForm');
        if (form) {
            form.addEventListener('submit', handleLoginSubmit);
        }
    });

    // Показать модальное окно подтверждения
    function showConfirmationModal() {
        document.getElementById('confirmation_user_id').value = currentUserId;
        document.getElementById('confirmationModal').style.display = 'block';
        document.getElementById('confirmation_code').focus();
    }
    
    // Скрыть модальное окно
    function hideConfirmationModal() {
        document.getElementById('confirmationModal').style.display = 'none';
    }
    
    // Обработка отправки формы подтверждения
    const confirmationForm = document.getElementById('confirmationForm');
    if (confirmationForm){
    confirmationForm.addEventListener('submit', async function(event) {
    
        event.preventDefault();
        
        const confirmBtn = document.getElementById('confirmBtn');
        const originalText = confirmBtn.textContent;
        
        confirmBtn.textContent = 'Проверка...';
        confirmBtn.disabled = true;
        
        try {
            const formData = new FormData(this);
            const jsonData = {};
            
            for (let [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            
            const response = await runInServerFetch(
                'http://localhost:8700/main/allow_any/check_confirmation_code_id/', 
                jsonData
            );
            
            if (response.ok) {
                const result = await response.json();
                alert('Email успешно подтвержден!');
                hideConfirmationModal();
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert(errorData.errorText || 'Ошибка подтверждения кода');
            }
            
        } catch (error) {
            console.error('Network error:', error);
            alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
        } finally {
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
        }
    });
    
    
    }
    // Обработка повторной отправки кода
    document.getElementById('resendCodeBtn')?.addEventListener('click', async function() {
        const resendBtn = this;
        const originalText = resendBtn.textContent;
        
        if (!currentUserId) {
            alert('Ошибка: пользователь не найден');
            return;
        }
        
        resendBtn.textContent = 'Отправка...';
        resendBtn.disabled = true;
        
        try {
            const response = await runInServerFetch(
                'http://localhost:8700/main/allow_any/update_confirmation_code_id/', 
                { user_id: currentUserId }
            );
            
            if (response.ok) {
                const result = await response.json();
                if (result.is_send_email) {
                    alert('Код подтверждения отправлен повторно!');
                } else {
                    alert('Не удалось отправить код. Попробуйте позже.');
                }
            } else {
                const errorData = await response.json();
                alert(errorData.errorText || 'Ошибка отправки кода');
            }
            
        } catch (error) {
            console.error('Network error:', error);
            alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
        } finally {
            resendBtn.textContent = originalText;
            resendBtn.disabled = false;
        }
    });
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Находим все формы на странице
        const forms = document.querySelectorAll('form');
        
        forms.forEach(form => {
            // Определяем тип формы по action или другим признакам
            const action = form.action || '';
            
            if (action.includes('create_account') || form.querySelector('[name*="password2"]')) {
                // Форма регистрации
                form.addEventListener('submit', handleRegistrationSubmit);
            } else if (action.includes('login') || (form.querySelector('[name="email"]') && form.querySelector('[name="password"]') && !form.querySelector('[name*="password2"]'))) {
                // Форма входа
                form.addEventListener('submit', handleLoginSubmit);
            }
        });
    });

    async function renderLkPage() {
        try {
            const token = localStorage.getItem('auth_token');
            
            const response = await fetch('http://localhost:8700/main/lk_all/get_lk/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const html = await response.text();
                
                // Заменяем содержимое страницы
                document.documentElement.innerHTML = html;
                
                // Обновляем URL без перезагрузки
                // window.history.pushState({}, '', '/lk/');
            } else {
                throw new Error('Ошибка загрузки ЛК');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    async function renderLkAllRecipesPage() {
        try {
            const boxlk = document.getElementById('box-lk');
            const token = localStorage.getItem('auth_token');
            
            const response = await fetch('http://localhost:8700/main/lk_all/get_lk_list_all_recipes/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const html = await response.text();
                
                // Заменяем содержимое страницы
                boxlk.innerHTML = html;
                
                // Обновляем URL без перезагрузки
                // window.history.pushState({}, '', '/lk/');
            } else {
                throw new Error('Ошибка загрузки ЛК');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    async function renderLkAllFavoritesPage() {
        try {
            const boxlk = document.getElementById('box-lk');
            const token = localStorage.getItem('auth_token');
            
            const response = await fetch('http://localhost:8700/main/lk_all/get_lk_list_my_favorites/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const html = await response.text();
                
                // Заменяем содержимое страницы
                boxlk.innerHTML = html;
                
                // Обновляем URL без перезагрузки
                // window.history.pushState({}, '', '/lk/');
            } else {
                throw new Error('Ошибка загрузки ЛК');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }


    async function handleAddRecipeSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        const formData = new FormData(form);
        const jsonData = {};
        
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }
        
        submitBtn.textContent = 'Добавление рецепта...';
        submitBtn.disabled = true;

        try {
            const token = localStorage.getItem('auth_token');
            const response = await fetch('http://localhost:8700/main/lk_chef/add_recipe/', {
                method: 'POST',
                body: JSON.stringify(jsonData), // Преобразуем в JSON
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const result = await response.json();
                
                if (result.recipe_id) {
                    alert('Рецепт успешно добавлен!');
                    window.location.reload();
                }
            } else {
                const errorData = await response.json();
                alert('Ошибка: ' + (errorData.detail || JSON.stringify(errorData)));
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('addRecipeForm');
        if (form) {
            form.addEventListener('submit', handleAddRecipeSubmit);
        }
    });



    async function handleEditProfileSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        const formData = new FormData(form);
        const jsonData = {};
        
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }
        
        submitBtn.textContent = 'Редактирование аккаунта...';
        submitBtn.disabled = true;

        try {
            const token = localStorage.getItem('auth_token');
            const response = await fetch('http://localhost:8700/main/lk_all/edit_profile/', {
                method: 'POST',
                body: JSON.stringify(jsonData), // Преобразуем в JSON
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const result = await response.json();
                
                if (result == "ok") {
                    alert('Редактирование успешно выполнено!');
                    window.location.reload();
                }
            } else {
                const errorData = await response.json();
                alert('Ошибка: ' + (errorData.detail || JSON.stringify(errorData)));
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('editAccount');
        if (form) {
            form.addEventListener('submit', handleEditProfileSubmit);
        }
    });


    async function renderLkRecipePage(id) {
        try {
            const boxlk = document.getElementById('box-lk');
            const token = localStorage.getItem('auth_token');
            
            const response = await fetch(`http://localhost:8700/main/lk_all/get_lk_get_recipe/?id=${id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const html = await response.text();
                
                // Заменяем содержимое страницы
                boxlk.innerHTML = html;
                
                // Обновляем URL без перезагрузки
                // window.history.pushState({}, '', '/lk/');
            } else {
                throw new Error('Ошибка загрузки ЛК');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    async function renderLkAddRecipeToFavorite(id) {
        const jsonData = {
            'id': id
        };
        try {
            const boxlk = document.getElementById('box-lk');
            const token = localStorage.getItem('auth_token');
            
            const response = await fetch(`http://localhost:8700/main/lk_all/add_recipe_to_favorite/`, {
                method: 'POST',
                body: JSON.stringify(jsonData),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `token ${token}`
                }
            });

            if (response.ok) {
                const html = await response.text();
                alert('Рецепт успешно добавлен в избранное!');
                
                // Заменяем содержимое страницы
                // boxlk.innerHTML = html;
                
                // Обновляем URL без перезагрузки
                // window.history.pushState({}, '', '/lk/');
            } else {
                throw new Error('Ошибка загрузки ЛК');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    async function handleAddCommentSubmit(event) {
    event.preventDefault();
    
    const form = document.getElementById('commentForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    // Собираем данные формы
    const formData = new FormData(form);
    const jsonData = {};
    
    for (let [key, value] of formData.entries()) {
        jsonData[key] = value;
    }
    
    submitBtn.textContent = 'Добавление комментария...';
    submitBtn.disabled = true;

    try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch('http://localhost:8700/main/lk_all/add_comment_to_recipe/', {
            method: 'POST',
            body: JSON.stringify(jsonData),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `token ${token}`
            }
        });

        if (response.ok) {
            const result = await response.json();
            
            if (result.comment_id) {
                alert('Комментарий успешно добавлен!');
                window.location.reload();
            } else {
                alert('Комментарий добавлен, но ID не получен');
            }
        } else {
            const errorData = await response.json();
            
            // Обработка ошибок валидации Django
            if (errorData.errors) {
                let errorMessages = [];
                for (let field in errorData.errors) {
                    if (field !== 'code') {
                        errorMessages = errorMessages.concat(errorData.errors[field]);
                    }
                }
                alert('Ошибки валидации: ' + errorMessages.join(', '));
            } else {
                alert('Ошибка: ' + (errorData.detail || JSON.stringify(errorData)));
            }
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Ошибка сети. Пожалуйста, попробуйте еще раз.');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
}
    </script>
